---
title: "exp13_analysis"
author: "Maya Śliwa"
format: html
editor: visual
---

## Quarto

Quarto enables you to weave together content and executable code into a finished document. To learn more about Quarto see <https://quarto.org>.

## Running Code

```{r}
library(readxl)
library(dplyr)
library(writexl)
library(dplyr)
setwd("~/Desktop/Szade_Lab/aktualne")
```

```{r}
# lista kolumn cytometrycznych 
cyto_cols <- c(
  "all_events",
  "singlets_cells",
  "Live_dead_Ly6C_subset",
  "FSC_A_medium_SSC_A_high",
  "FSC_low.SSC_low",
  "FSChigh_SSChigh",
  "FSClow_SSC_high",
  "SSC_low_FSC_high",
  "cKit_neg",
  "low6C_mono",
  "CD16_32neg_CD71hi",
  "Ter119neg_CD105pos",
  "Ter119pos_CD105pos",
  "Ter119pos_CD105neg",
  "Ter119neg_CD105neg",
  "CD16_32pos_CD71hi",
  "CD16_32neg_CD71pos",
  "CD16_32low_CD71low",
  "CD16_32neg_CD71neg",
  "monocytes_1",
  "FcR_hi",
  "FcR_low",
  "FcR_neg",
  "neutrophils",
  "non_mielo_wide",
  "Ter119_pos_CD16_32neg",
  "CD71high_Ter119neg",
  "CD71pos_Ter119low",
  "CD71pos_Ter119neg",
  "non_mielo",
  "early_baso",
  "late_baso",
  "polychrom",
  "proerythro",
  "Q1_CD150neg_CD105pos",
  "Q2_CD150pos_CD105pos",
  "Q3_CD150pos_CD105neg",
  "Q4_CD150neg_CD105neg",
  "cKit_pos",
  "CD150pos_CD16_32neg",
  "GMP_1",
  "GMP_2",
  "non_GMP",
  "CMP_1",
  "CFUE",
  "preCFUE",
  "preGM",
  "preMegE",
  "CD71pos_CD34neg",
  "CMP_1_CD71pos_CD105neg",
  "CMP_1_CD71pos_CD105pos",
  "CMP_2",
  "trombo"
)

# wczytanie danych
df <- read_excel("ERC_aim1_exp13_summary.xlsx") 

# OBIEKT R z samą cytometrią
df_cyto <- df %>%
  select(all_of(cyto_cols))

# normalizacja % of live dla wszystkich
denom <- "Live_dead_Ly6C_subset"
gate_cols <- setdiff(colnames(df_cyto), denom)

df_cyto_pct_live <- df_cyto %>%
  mutate(
    across(
      all_of(gate_cols),
      ~ ifelse(.data[[denom]] == 0 | is.na(.data[[denom]]), NA_real_, (.x / .data[[denom]]) * 100),
      .names = "{.col}_pct_live"
    )
  )

#normalizacja % of live dla zgatowanych populacji
gated_populations <- c(
  "low6C_mono",
  "monocytes_1",
  "CD16_32neg_CD71hi",
  "CD16_32pos_CD71hi",
  "CD16_32neg_CD71pos",
  "CD16_32low_CD71low",
  "CD16_32neg_CD71neg",
  "FcR_hi",
  "FcR_low",
  "FcR_neg",
  "neutrophils",
  "Ter119_pos_CD16_32neg",
  "CD71high_Ter119neg",
  "CD71pos_Ter119low",
  "CD71pos_Ter119neg",
  "early_baso",
  "late_baso",
  "polychrom",
  "proerythro",
  "Ter119neg_CD105pos",
  "Ter119pos_CD105pos",
  "Ter119pos_CD105neg",
  "Ter119neg_CD105neg",
  "Q1_CD150neg_CD105pos",
  "Q2_CD150pos_CD105pos",
  "Q3_CD150pos_CD105neg",
  "Q4_CD150neg_CD105neg",
  "CD150pos_CD16_32neg",
  "GMP_1",
  "GMP_2",
  "non_GMP",
  "CMP_1",
  "CMP_2",
  "CFUE",
  "preCFUE",
  "preGM",
  "preMegE",
  "CD71pos_CD34neg",
  "CMP_1_CD71pos_CD105neg",
  "CMP_1_CD71pos_CD105pos",
  "trombo"
)

denom <- "Live_dead_Ly6C_subset"
df_gated_pct_live <- df_cyto %>%
  mutate(
    across(
      all_of(gated_populations),
      ~ ifelse(
        .data[[denom]] == 0 | is.na(.data[[denom]]),
        NA_real_,
        (.x / .data[[denom]]) * 100
      ),
      .names = "{.col}_pct_live"
    )
  ) %>%
  select(ends_with("_pct_live"))

# HISTOGRAMY DLA WSZYSTKICH POPULACJI
library(ggplot2)
df_in <- df_gated_pct_live
out_dir <- file.path(getwd(), "exp_13_histograms_pct_live")
if (!dir.exists(out_dir)) dir.create(out_dir, recursive = TRUE)

# Kolumny do histogramów (wszystkie % of live)
pct_cols <- grep("_pct_live$", colnames(df_in), value = TRUE)

if (length(pct_cols) == 0) {
  stop("Nie znaleziono kolumn kończących się na '_pct_live'")
}

# === HISTOGRAM LOOP ===
for (col in pct_cols) {
  p <- ggplot(df_in, aes(x = .data[[col]])) +
    geom_histogram(bins = 50) +
    labs(
      title = paste("Histogram:", col),
      x = "% of live",
      y = "Count"
    ) +
    theme_minimal()
  
  # nazwa pliku
  safe_name <- gsub("[^A-Za-z0-9_\\-]+", "_", col)
  
  ggsave(
    filename = file.path(out_dir, paste0(safe_name, ".png")),
    plot = p,
    width = 7,
    height = 5,
    dpi = 300
  )
}

message("Histogramy zapisane w: ", out_dir)

library(dplyr)
library(ggplot2)

############## PCA ############################
library(tidyr)
pca_mat <- df_gated_pct_live %>%
  mutate(across(everything(), ~ replace_na(.x, 0))) %>%
  as.matrix()

pca_res <- prcomp(
  log1p(pca_mat),
  center = TRUE,
  scale. = TRUE
)

var_explained <- (pca_res$sdev^2) / sum(pca_res$sdev^2) * 100
pca_df <- as.data.frame(pca_res$x) %>%
  mutate(
    PC1 = PC1,
    PC2 = PC2
  )

ggplot(pca_df, aes(x = PC1, y = PC2)) +
  geom_point(size = 3, alpha = 0.8) +
  labs(
    title = "PCA of gated populations (% of live)",
    subtitle = paste0(
      "PC1: ", round(var_explained[1], 1), "% | ",
      "PC2: ", round(var_explained[2], 1), "%"
    ),
    x = paste0("PC1 (", round(var_explained[1], 1), "%)"),
    y = paste0("PC2 (", round(var_explained[2], 1), "%)")
  ) +
  theme_minimal(base_size = 14)
```

```{r}
# PCA 
pcs_to_use <- 1:5
X_pca <- pca_res$x[, pcs_to_use, drop = FALSE]

# UMAP (NA PCA)
library(uwot)
set.seed(123)

umap_res <- umap(
  X_pca,
  n_neighbors = 10,
  min_dist = 0.2,
  metric = "euclidean"
)

umap_df <- as.data.frame(umap_res)
colnames(umap_df) <- c("UMAP1", "UMAP2")

# --- DBSCAN (NA PCA, NIE NA UMAP) ---
library(dbscan)

kNNdistplot(X_pca, k = 5)
abline(h = 0.8, col = "red", lwd = 2)

db <- dbscan(
  X_pca,
  eps = 0.8,
  minPts = 5
)

table(db$cluster)

# wizualizacja 
umap_df$cluster <- factor(db$cluster)

library(ggplot2)
ggplot(umap_df, aes(UMAP1, UMAP2, color = cluster)) +
  geom_point(size = 3, alpha = 0.85) +
  theme_minimal(base_size = 14) +
  labs(
    title = "UMAP visualization of DBSCAN clusters",
    subtitle = "DBSCAN performed on PC1–PC5",
    color = "Cluster"
  )
```

Algorytm DBSCAN został zastosowany do przestrzeni PC1–PC5 w celu identyfikacji lokalnie zagęszczonych struktur w danych, niezależnie od projekcji UMAP, która służy wyłącznie do wizualizacji relacji pomiędzy próbkami. Większość próbek została zaklasyfikowana jako "szum" (klaster 0), co wskazuje na ciągły charakter zmienności fenotypowej bez wyraźnych globalnych podziałów. Jednocześnie DBSCAN wykrył kilka niewielkich, dobrze odseparowanych klastrów (1–5), odpowiadających lokalnie stabilnym konfiguracjom fenotypowym.

```{r}
df_clusters <- df %>%
  mutate(
    cluster = factor(db$cluster)
  )
table(df_clusters$cluster)
table(df_clusters$GROUP)
tab <- table(df_clusters$cluster, df_clusters$GROUP)
tab
```

Rozkład grup eksperymentalnych jest silnie wymieszany pomiędzy klastrami, a żaden z klastrów nie wykazywał specyficzności względem pojedynczego warunku. Sugeruje to, że klastry wykryte przez DBSCAN reprezentują stany fenotypowe, a nie bezpośrednie efekty eksperymentalne.

```{r}
library(dplyr)
library(tidyr)

df_prof <- df_gated_pct_live %>%
  mutate(cluster = factor(db$cluster))  # 0 = noise, 1 = klaster
summary_tbl <- df_prof %>%
  pivot_longer(
    cols = ends_with("_pct_live"),
    names_to = "population",
    values_to = "value"
  ) %>%
  group_by(population, cluster) %>%
  summarise(
    mean = mean(value, na.rm = TRUE),
    median = median(value, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  pivot_wider(
    names_from = cluster,
    values_from = c(mean, median),
    names_glue = "{.value}_cluster{cluster}"
  ) %>%
  mutate(
    diff_mean = mean_cluster1 - mean_cluster0,
    log2FC = log2((mean_cluster1 + 1e-6) / (mean_cluster0 + 1e-6))
  ) %>%
  arrange(desc(abs(diff_mean)))

summary_tbl

ranking_tbl <- summary_tbl %>%
  select(population, diff_mean, log2FC) %>%
  arrange(desc(abs(diff_mean)))

ranking_tbl
```

Profil fenotypowy klastra 1 wykazuje wyraźne wzbogacenie w dojrzałe populacje mieloidalne, w szczególności monocyty i neutrofile, przy jednoczesnym istotnym zubożeniu populacji progenitorowych (GMP, CMP) oraz linii erytroidalnej. Klaster charakteryzuje się zwiększonym udziałem komórek FcR\^hi/FcR\^low oraz obniżonym udziałem wczesnych stadiów różnicowania, co wskazuje na przesunięcie fenotypowe w kierunku dojrzałych, funkcjonalnych komórek mieloidalnych –\> klaster 1 reprezentuje stabilny stan fenotypowy, a nie efekt specyficzny dla pojedynczego warunku eksperymentalnego.
